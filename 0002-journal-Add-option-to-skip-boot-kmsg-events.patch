From 4186cb11ddf3c731d0c365bb819a4479ecf6b299 Mon Sep 17 00:00:00 2001
From: Dimitri John Ledkov <dimitri.j.ledkov@intel.com>
Date: Tue, 23 Jun 2015 11:25:41 +0100
Subject: [PATCH 02/45] journal: Add option to skip boot kmsg events

The `BootKMsg` boolean is added. It defaults to `true` in the default
system namespace, and doesn't change the default behavior of the
journal.

If set to `false`, then, when `systemd-journald` starts in the default
namespace, it will ignore any existing message in the `kmsg` ring buffer
and not insert these into the journal. We do this to reduce the time
needed for the journal to start and reduce CPU overhead, since the
kernel ring buffer can be large, and contain information that the user
perhaps does not care about (e.g. initcall debug output).

The information remains accessible through `dmesg` in case it needs
to be retrieved later. This contains code originally added to
ClearLinux by Dimitri -xnox- Ledkov in 2015.

Signed-off-by: Auke Kok <auke-jan.h.kok@intel.com>
Cc: Dimitri John Ledkov <xnox@ubuntu.com>
---
 man/journald.conf.xml            |  9 +++++++++
 src/journal/journald-gperf.gperf |  1 +
 src/journal/journald-kmsg.c      | 11 +++++++++++
 src/journal/journald-server.c    |  2 +-
 src/journal/journald-server.h    |  1 +
 5 files changed, 23 insertions(+), 1 deletion(-)

diff -Naur systemd-246.20200811/man/journald.conf.xml systemd-246.20200811.tpg/man/journald.conf.xml
--- systemd-246.20200811/man/journald.conf.xml	2020-08-07 15:09:53.000000000 +0000
+++ systemd-246.20200811.tpg/man/journald.conf.xml	2020-08-18 10:09:21.817030856 +0000
@@ -421,6 +421,15 @@
       </varlistentry>
 
       <varlistentry>
+        <term><varname>BootKMsg=</varname></term>
+
+        <listitem><para>Takes a boolean value. If enabled <command>systemd-journal</command> processes
+        <filename>/dev/kmsg</filename> messages generated by the kernel before it started. If disabled,
+        those messages are not read and can be obtained by other means, like <command>dmesg</command>.
+        In the default journal namespace this option is enabled by default, it is disabled in all others.</para></listitem>
+      </varlistentry>
+
+      <varlistentry>
         <term><varname>TTYPath=</varname></term>
 
         <listitem><para>Change the console TTY to use if
diff -Naur systemd-246.20200811/src/journal/journald-gperf.gperf systemd-246.20200811.tpg/src/journal/journald-gperf.gperf
--- systemd-246.20200811/src/journal/journald-gperf.gperf	2020-08-07 15:09:53.000000000 +0000
+++ systemd-246.20200811.tpg/src/journal/journald-gperf.gperf	2020-08-18 10:10:10.282031129 +0000
@@ -22,6 +22,7 @@
 Journal.Compress,           config_parse_compress,   0, offsetof(Server, compress)
 Journal.Seal,               config_parse_bool,       0, offsetof(Server, seal)
 Journal.ReadKMsg,           config_parse_bool,       0, offsetof(Server, read_kmsg)
+Journal.BootKMsg,           config_parse_bool,       0, offsetof(Server, boot_kmsg)
 Journal.Audit,              config_parse_tristate,   0, offsetof(Server, set_audit)
 Journal.SyncIntervalSec,    config_parse_sec,        0, offsetof(Server, sync_interval_usec)
 # The following is a legacy name for compatibility
diff -Naur systemd-246.20200811/src/journal/journald-kmsg.c systemd-246.20200811.tpg/src/journal/journald-kmsg.c
--- systemd-246.20200811/src/journal/journald-kmsg.c	2020-08-07 15:09:53.000000000 +0000
+++ systemd-246.20200811.tpg/src/journal/journald-kmsg.c	2020-08-18 10:11:38.099031623 +0000
@@ -384,6 +384,17 @@
         if (!s->read_kmsg)
                 return 0;
 
+        if (!s->boot_kmsg) {
+                /* clear out /dev/kmsg, we don't want all its messages */
+                char buffer[40960];
+                while (1) {
+                        int ret;
+                        ret = read(s->dev_kmsg_fd, buffer, 40960);
+                        if (ret <= 0)
+                                break;
+                }
+        }
+
         r = sd_event_add_io(s->event, &s->dev_kmsg_event_source, s->dev_kmsg_fd, EPOLLIN, dispatch_dev_kmsg, s);
         if (r < 0) {
 
diff -Naur systemd-246.20200811/src/journal/journald-server.c systemd-246.20200811.tpg/src/journal/journald-server.c
--- systemd-246.20200811/src/journal/journald-server.c	2020-08-18 10:07:02.936030073 +0000
+++ systemd-246.20200811.tpg/src/journal/journald-server.c	2020-08-18 10:12:01.348031754 +0000
@@ -2239,7 +2239,7 @@
                 return r;
 
         /* By default, only read from /dev/kmsg if are the main namespace */
-        s->read_kmsg = !s->namespace;
+        s->boot_kmsg = s->read_kmsg = !s->namespace;
         s->storage = s->namespace ? STORAGE_PERSISTENT : STORAGE_AUTO;
 
         journal_reset_metrics(&s->system_storage.metrics);
diff -Naur systemd-246.20200811/src/journal/journald-server.h systemd-246.20200811.tpg/src/journal/journald-server.h
--- systemd-246.20200811/src/journal/journald-server.h	2020-08-07 15:09:53.000000000 +0000
+++ systemd-246.20200811.tpg/src/journal/journald-server.h	2020-08-18 10:12:47.060032012 +0000
@@ -108,6 +108,7 @@
         JournalCompressOptions compress;
         bool seal;
         bool read_kmsg;
+        bool boot_kmsg;
         int set_audit;
 
         bool forward_to_kmsg;
-- 
2.26.0
